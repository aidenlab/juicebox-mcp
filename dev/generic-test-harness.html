<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Juicebox Test Harness</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <!-- Font Awesome CSS-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.css">

    <!-- Juicebox CSS-->
    <link rel="stylesheet" type="text/css" href="../css/juicebox.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        #app-container {
            width: 100%;
            height: 100vh;
        }
        .save-session-button,
        .load-session-button {
            position: fixed;
            top: 20px;
            z-index: 1000;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .save-session-button {
            right: 20px;
        }
        .load-session-button {
            right: 180px;
        }
        .save-session-button:hover,
        .load-session-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .save-session-button:active,
        .load-session-button:active {
            transform: translateY(0);
        }
        #session-file-input {
            display: none;
        }
    </style>
</head>

<body>

<button id="save-session-button" class="save-session-button">Save Session</button>
<button id="load-session-button" class="load-session-button">Load Session</button>
<input type="file" id="session-file-input" accept=".json" />
<div id="app-container"></div>

<script type="module">

    import { Application } from '../src/Application.js';
    import juicebox from '../js/index.js';
 
    const config_erez_bug =
        {
            "browsers": [
                {
                    "backgroundColor": "255,255,255",
                    "url": "https://s3.us-east-1.wasabisys.com/aiden-suhas/hic_files/FINAL_GRCh38_processing/LCL/LCL_combined/8_1_22/inter_30.hic/inter_30.hic",
                    "name": "inter_30.hic",
                    "state": "23,23,6,5052.633675000001,5049.383675000001,640,640,4,VC",
                    "colorScale": "R:500:6.214608098422191,255,0,0:6.214608098422191,0,0,255",
                    "nvi": "1373857641721,71224",
                    "controlUrl": "https://www.encodeproject.org/files/ENCFF053VBX/@@download/ENCFF053VBX.hic",
                    "controlName": "MboI primary+replicate GM12878 experiment",
                    "displayMode": "AOB",
                    "controlNvi": "54305946375,47429"
                },
                {
                    "backgroundColor": "255,255,255",
                    "url": "https://www.encodeproject.org/files/ENCFF053VBX/@@download/ENCFF053VBX.hic",
                    "name": "MboI primary+replicate GM12878 experiment",
                    "state": "23,23,6,5052.633675000001,5049.383675000001,640,640,4,VC",
                    "colorScale": "84.58193578581977,255,0,0",
                    "nvi": "54305946375,47429"
                },
                {
                    "backgroundColor": "255,255,255",
                    "url": "https://s3.us-east-1.wasabisys.com/aiden-suhas/hic_files/FINAL_GRCh38_processing/LCL/LCL_combined/8_1_22/inter_30.hic/inter_30.hic",
                    "name": "inter_30.hic",
                    "state": "23,23,6,5052.633675000001,5049.383675000001,640,640,4,VC",
                    "colorScale": "52.98886154812313,255,0,0",
                    "nvi": "1373857641721,71224"
                }
            ],
            "caption": "left panel: deep lcl in situ hg19; middle panel: encode gm12878 in situ hg38 & deep lcl intact; right panel: encode gm12878 in situ hg38"
        };

    const config_locus_state_hacks = {
        "url": "https://www.encodeproject.org/files/ENCFF799QGA/@@download/ENCFF799QGA.hic",
        "name": "in-situ agar GM12878 MboI experiment",
        // "locus": 'all'
        // "locus": "18:28,504,357-29,748,974 18:28,504,357-29,748,974",
    }

    const config_multiple_browsers =
        {
            "browsers": [
                {
                    "locus": "egfr",
                    width: 512,
                    height: 512,
                    "backgroundColor": "136,133,1",
                    "url": "https://www.encodeproject.org/files/ENCFF473CAA/@@download/ENCFF473CAA.hic",
                    "name": "browser - thing one",
                    // "state": "17,17,8,12025.0154,12025.0154,640,640,1,NONE",
                    "colorScale": "12,131,249,2",
                    "selectedGene": "ace",
                    "nvi": "1077514950,36479",
                    "tracks": [
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | GM12878 combined loops",
                            "color": "#ffce6e"
                        },
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/huvec/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | HUVEC combined loops",
                            "color": "#ff39ff"
                        }
                    ]
                },
                {
                    "locus": "egfr",
                    width: 720,
                    height: 720,
                    "backgroundColor": "136,133,1",
                    "url": "https://www.encodeproject.org/files/ENCFF473CAA/@@download/ENCFF473CAA.hic",
                    "name": "browser - thing two",
                    // "state": "17,17,8,12025.0154,12025.0154,640,640,1,NONE",
                    "colorScale": "12,131,249,2",
                    "selectedGene": "ace",
                    "nvi": "1077514950,36479",
                    "tracks": [
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | GM12878 combined loops",
                            "color": "#ffce6e"
                        },
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/huvec/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | HUVEC combined loops",
                            "color": "#ff39ff"
                        }
                    ]
                }
            ],
            "selectedGene": "ace"
        };

    const config_2d_track =
        {
            "browsers": [
                {
                    width: 512,
                    height: 512,
                    "backgroundColor": "136,133,1",
                    "url": "https://www.encodeproject.org/files/ENCFF473CAA/@@download/ENCFF473CAA.hic",
                    "name": "in-situ agar GM12878 MboI experiment",
                    "state": "17,17,8,12025.0154,12025.0154,640,640,1,NONE",
                    "colorScale": "12,131,249,2",
                    "selectedGene": "ace",
                    "nvi": "1077514950,36479",
                    "tracks": [
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | GM12878 combined loops",
                            "color": "#ffce6e"
                        },
                        {
                            "url": "https://hicfiles.s3.amazonaws.com/hiseq/huvec/in-situ/combined_peaks.txt",
                            "name": "Rao & Huntley et al. | Cell 2014 | HUVEC combined loops",
                            "color": "#ff39ff"
                        }
                    ]
                }
            ],
            "selectedGene": "ace"
        };

    const config =
        {
            "backgroundColor": "255,255,255",
            "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/dilution/combined.hic",

            // TODO: Debugging map
            // "url": "https://www.encodeproject.org/files/ENCFF219YOB/@@download/ENCFF219YOB.hic",

            "name": "Combined",
            // "state": "17,17,8,12025.0154,12025.0154,640,640,1,NONE",
            // "locus": "18:28,504,357-29,748,974 18:28,504,357-29,748,974",
            // "locus": "18:28,504,357-29,748,974",
            "locus": "egfr",
            // "locus": "all",
            "normalization": "NONE",
            "colorScale": "66.20668236071833,255,0,0",
        };

    const config_with_tracks =
        {
            "backgroundColor": "255,255,255",
            "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/dilution/combined.hic",
            "name": "Combined",
            "locus": "18:28,504,357-29,748,974 18:28,504,357-29,748,974",
            "normalization": "VC_SQRT",
            "colorScale": "66.20668236071833,255,0,0",
            "tracks": [
                {
                    "url": "https://hgdownload.soe.ucsc.edu/goldenPath/hg19/database/ncbiRefSeq.txt.gz",
                    "type": "annotation",
                    "format": "refgene",
                    "name": "Refseq Genes",
                },
                {
                    "url": "https://www.encodeproject.org/files/ENCFF144KUK/@@download/ENCFF144KUK.bigWig",
                    "type": "wig",
                    "format": "bigwig",
                    "name": "Homo sapiens GM12878 CTCF "
                },
                {
                    "url": "https://hicfiles.s3.amazonaws.com/hiseq/gm12878/in-situ/combined_peaks.txt",
                    "name": "Rao & Huntley et al. | Cell 2014 | GM12878 combined loops"
                },
                {
                    "url": "https://hicfiles.s3.amazonaws.com/hiseq/hap1/in-situ/combined_peaks.txt",
                    "name": "Sanborn & Rao et al. | PNAS 2015 | Hap1 loops",
                    "color": "#fffa03",
                    "displayMode": "upper"
                },
                {
                    "url": "https://hicfiles.s3.amazonaws.com/external/mumbach/GSE80820_HiChIP_GM_cohesin_peaks.txt",
                    "name": "Mumbach Rubin Flynn et al. | Nature Methods 2016 | GM12878 cohesin combined loops",
                    "color": "#000000",
                    "displayMode": "lower"
                }
            ]
        };

    const config_a_b_maps =
        {
            "browsers": [
                {
                    "backgroundColor": "0,74,136",
                    "url": "https://hicfiles.s3.amazonaws.com/hiseq/imr90/in-situ/combined.hic",
                    "name": "Combined",
                    "state": "7,7,5,815.66029,815.66029,640,640,1,NONE",
                    "colorScale": "23,255,114,110",
                    "selectedGene": "egfr",
                    "nvi": "13433880319,35723",
                    "controlUrl": "https://s3.amazonaws.com/hicfiles/hiseq/degron/untreated/unsynchronized/HIC005.hic",
                    "controlName": "Untreated, HIC005",
                    "displayMode": "B",
                    "controlNvi": "6846576837,36479"
                }
            ],
            "selectedGene": "egfr"
        };

    // Simplified configuration format demonstrating the refactored color scale system
    // Key principle: Single colorScale for A/B modes, separate ratioColorScale for AOB/BOA modes
    const enhanced_config =
        {
            // Map URLs
            "url": "https://hicfiles.s3.amazonaws.com/hiseq/imr90/in-situ/combined.hic",
            "name": "Contact Map (Combined)",
            "controlUrl": "https://s3.amazonaws.com/hicfiles/hiseq/degron/untreated/unsynchronized/HIC005.hic",
            "controlName": "Control Map (Untreated, HIC005)",
            
            // Normalization vector indices
            "nvi": "13433880319,35723",
            "controlNvi": "6846576837,36479",
            
            // State (chromosome, locus, zoom, etc.)
            "state": "7,7,5,815.66029,815.66029,640,640,1,NONE",
            
            // Color scale - Single foreground color scale used for BOTH A and B modes
            // Format: "threshold,r,g,b" (e.g., "2000,255,0,0" = threshold 2000, red)
            "colorScale": "2000,255,0,0",  // Used for both Contact Map (A) and Control Map (B)
            
            // Background color - Single background color shared across ALL modes (A, B, AOB, BOA)
            // Format: "r,g,b" (e.g., "255,255,255" = white)
            "backgroundColor": "255,255,255",  // Shared background for all display modes
            
            // Ratio color scale - Used for AOB/BOA ratio modes (only relevant when controlUrl is present)
            // Format: "R:threshold:positiveScale:negativeScale"
            //   - threshold: Ratio threshold (e.g., 5 means ratios > 5 are positive, < 1/5 are negative)
            //   - positiveScale: "logThreshold,r,g,b" for positive ratios (ratios > threshold)
            //   - negativeScale: "logThreshold,r,g,b" for negative ratios (ratios < 1/threshold)
            // Example: "R:5:1.609,255,0,0:1.609,0,0,255" means:
            //   - Threshold: 5
            //   - Positive (ratios > 5): Red (255,0,0)
            //   - Negative (ratios < 0.2): Blue (0,0,255)
            // Note: If not specified, defaults are used (threshold=5, positive=red, negative=blue)
            // This is saved automatically when users adjust ratio colors via the UI
            "ratioColorScale": "R:5:1.6094379124341003,255,0,0:1.6094379124341003,0,0,255",
            
            // Initial display mode
            // Options: 
            // "A" (Contact Map), 
            // "B" (Control Map), 
            // "AOB" (Contact/Control ratio), 
            // "BOA" (Control/Contact ratio),
            // "AMB" (Contact Map - Control Map)
            "displayMode": "A",  // Start showing Contact Map
            
            // Optional: Gene selection
            "selectedGene": "egfr"
        };

    // Select which config to test by changing the variable below
    // Available configs:
    //   - config_erez_bug
    //   - config_locus_state_hacks
    //   - config_multiple_browsers
    //   - config_2d_track
    //   - config
    //   - config_with_tracks
    //   - config_a_b_maps
    //   - enhanced_config
    const selectedConfig = enhanced_config;

    // Initialize application
    const app = new Application();
    
    try {
        await app.init(document.getElementById("app-container"), selectedConfig);
        console.log('Test harness initialized successfully');
        console.log('Using config:', selectedConfig);
    } catch (error) {
        console.error('Error initializing test harness:', error);
    }

    // Save session functionality
    function saveSession() {
        try {
            const sessionData = juicebox.toJSON();
            const jsonString = JSON.stringify(sessionData, null, 2);
            
            // Create a blob and download it
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `juicebox-session-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('Session saved successfully');
        } catch (error) {
            console.error('Error saving session:', error);
            alert('Error saving session: ' + error.message);
        }
    }

    // Load session functionality
    async function loadSession() {
        const fileInput = document.getElementById('session-file-input');
        fileInput.click();
    }

    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        try {
            const fileText = await file.text();
            let sessionData;
            
            // Try to parse as JSON
            try {
                sessionData = JSON.parse(fileText);
            } catch (parseError) {
                // If it's a compressed session format
                // Handle "session=blob:..." format (from compressedSession())
                if (fileText.startsWith("session=blob:")) {
                    const { BGZip } = await import('../node_modules/igv-utils/src/index.js');
                    const compressedData = fileText.substring(13); // Skip "session=blob:"
                    const jsonString = BGZip.uncompressString(compressedData);
                    sessionData = JSON.parse(jsonString);
                } 
                // Handle "blob:" or "data:" format
                else if (fileText.startsWith("blob:") || fileText.startsWith("data:")) {
                    const { BGZip } = await import('../node_modules/igv-utils/src/index.js');
                    const compressedData = fileText.substring(5); // Skip "blob:" or "data:"
                    const jsonString = BGZip.uncompressString(compressedData);
                    sessionData = JSON.parse(jsonString);
                } else {
                    throw parseError;
                }
            }

            // Restore the session
            await juicebox.restoreSession(document.getElementById("app-container"), sessionData);
            console.log('Session loaded successfully');
            
            // Reset the file input so the same file can be loaded again
            event.target.value = '';
        } catch (error) {
            console.error('Error loading session:', error);
            alert('Error loading session: ' + error.message);
            event.target.value = '';
        }
    }

    // Attach button handlers
    document.getElementById('save-session-button').addEventListener('click', saveSession);
    document.getElementById('load-session-button').addEventListener('click', loadSession);
    document.getElementById('session-file-input').addEventListener('change', handleFileSelect);

</script>

</body>

</html>
