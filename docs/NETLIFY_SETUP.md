# Netlify Deployment Guide for Juicebox MCP Frontend

This guide covers the configuration for hosting the Juicebox MCP frontend on Netlify.

## Overview

The Juicebox MCP project has two build configurations:
- **Library build** (`npm run build`): Builds the library for npm package distribution
- **Netlify build** (`npm run build:netlify`): Builds a standard web app for Netlify hosting

**Important Note**: Even though the frontend is hosted on Netlify, it runs in your browser on your local machine. This means the WebSocket connection from the browser to your local WebSocket server can use `ws://localhost:3001` - no tunneling required for the WebSocket connection!

Tunneling is only needed for the MCP HTTP endpoint (port 3000) if you want ChatGPT/Cursor to connect to your local MCP server.

## Quick Setup Checklist

- [ ] MCP server running locally
- [ ] MCP HTTP tunnel active (port 3000) - only if using ChatGPT/Cursor
- [ ] `VITE_WS_URL` set in Netlify environment variables to `ws://localhost:3001`
- [ ] Netlify deployment completed

## Build Configuration

### For Netlify Deployment

Use the Netlify-specific build command:

```bash
npm run build:netlify
```

This uses `vite.config.netlify.js` which:
- Builds as a standard web app (not a library)
- Outputs to `dist/` directory
- Includes `index.html` as the entry point
- Uses `src/main.js` as the application entry point

### For Library Distribution

Use the standard build command:

```bash
npm run build
```

This uses `vite.config.js` which builds the library for npm package distribution.

## Netlify Configuration

The project includes a `netlify.toml` file that configures:
- Build command: `npm run build:netlify`
- Publish directory: `dist`
- SPA routing: All routes redirect to `index.html`

## Setup Steps

### Step 1: Start Your MCP Server

**Important:** When hosting the frontend on Netlify, you must start the MCP server with the `-u` (or `--browser-url`) command line parameter specifying your Netlify URL. This ensures that connection links generated by the MCP server point to your Netlify deployment.

```bash
cd /path/to/juicebox-mcp
node server.js --browser-url https://your-app.netlify.app/
```

Replace `https://your-app.netlify.app` with your actual Netlify URL.

**Alternative syntax:**
```bash
node server.js -u https://your-app.netlify.app
```

The server will start on:
- MCP endpoint: `http://localhost:3000/mcp`
- WebSocket: `ws://localhost:3001`

### Step 2: Create Tunnel for MCP HTTP (Optional)

**Note**: You only need a tunnel for the MCP HTTP endpoint (port 3000) if you want ChatGPT/Cursor to connect to your local MCP server. The WebSocket connection (port 3001) does NOT need tunneling because the frontend runs in your browser, which can connect directly to `localhost:3001`.

**If using ChatGPT/Cursor**, create a tunnel for the MCP HTTP endpoint:

#### Using ngrok:

```bash
ngrok http 3000
```
Creates URL (e.g., `https://sagittal-christiana-glareless.ngrok-free.dev`)

**If you're only testing locally** (not using ChatGPT/Cursor), you can skip tunneling entirely.

### Step 3: Configure Netlify

⚠️ **CRITICAL**: The `VITE_WS_URL` environment variable is **REQUIRED** for Netlify deployments. Even though the frontend is hosted on Netlify, it runs in your browser, so it can connect directly to your local WebSocket server.

1. Go to your Netlify site dashboard
2. Navigate to **Site settings** → **Environment variables**
3. Add a new variable:
   - **Key**: `VITE_WS_URL`
   - **Value**: `ws://localhost:3001`
   - ⚠️ **Important**: 
     - Use `ws://localhost:3001` (not `wss://`) since you're connecting from your local browser to your local server
     - This variable is **mandatory** for Netlify - the connection will fail without it
     - The frontend cannot auto-detect the WebSocket URL when hosted on Netlify
4. **Redeploy** your site (or trigger a new deployment) after setting the variable

### Step 4: Configure MCP Client (Cursor/ChatGPT)

Configure your MCP client with the tunneled MCP HTTP URL.

**For Cursor:**
Add to Cursor Settings → Features → Model Context Protocol:
```json
{
  "mcpServers": {
    "juicebox-server": {
      "url": "https://your-mcp-tunnel-url.ngrok-free.app/mcp"
    }
  }
}
```

**For ChatGPT:**
1. Open ChatGPT → Settings → Personalization → Model Context Protocol
2. Add server:
   - **Name**: `juicebox-server`
   - **URL**: `https://your-mcp-tunnel-url.ngrok-free.app/mcp` (include `/mcp`!)
   - **Transport**: HTTP or Streamable HTTP
   - **Note**: Only needed if using ChatGPT/Cursor. If testing locally without MCP client, skip this step.

## Testing the Connection

1. **Open your Netlify site** in a browser
2. **Open browser console** (F12)
3. **Check for WebSocket connection logs**:
   - Should see: `WebSocket connected`
   - Status indicator should show "connected"

4. **Test MCP connection**:
   - In Cursor/ChatGPT, try: "Load a Hi-C map"
   - The map should load in your Netlify app

## Important Notes

- **WebSocket connection**: Uses `ws://localhost:3001` - no tunneling needed! The frontend runs in your browser, which can connect directly to your local WebSocket server.
- **MCP HTTP tunnel**: Only needed if using ChatGPT/Cursor. Keep the tunnel active while using the MCP client.
- **Redeploy Netlify after changes**: When you update `VITE_WS_URL` in Netlify, you must trigger a new deployment for the change to take effect.
- **Build command**: Make sure Netlify is configured to use `npm run build:netlify` (this is set in `netlify.toml`)

## Troubleshooting

### WebSocket Not Connecting

- ✅ **REQUIRED**: `VITE_WS_URL` must be set in Netlify environment variables to `ws://localhost:3001` (this is mandatory, not optional)
- ✅ Check that you've redeployed after setting the variable (environment variables require a redeploy)
- ✅ Use `ws://localhost:3001` (not `wss://`) - you're connecting from your local browser to your local server
- ✅ Verify your local WebSocket server is running on port 3001: `lsof -i :3001`
- ✅ Check browser console for connection errors
- ✅ Check browser console logs - should show: `Connecting to WebSocket server at ws://localhost:3001...`
- ✅ Make sure you're accessing the Netlify site from the same machine where the server is running

### MCP Client Can't Connect

- ✅ Only relevant if using ChatGPT/Cursor
- ✅ Verify MCP endpoint URL includes `/mcp` at the end
- ✅ Check that MCP server is running locally on port 3000
- ✅ Ensure MCP tunnel is still active (if using one)
- ✅ Check server logs for connection errors

### Build Fails on Netlify

- ✅ Verify `netlify.toml` is in the repository root
- ✅ Check that `vite.config.netlify.js` exists
- ✅ Ensure all dependencies are listed in `package.json`
- ✅ Check Netlify build logs for specific errors

### Changes Not Appearing in Browser

- ✅ Verify WebSocket connection is established (check browser console)
- ✅ Ensure MCP server is running and broadcasting commands
- ✅ Check that WebSocket server is running on port 3001
- ✅ Verify you're using the correct build command (`build:netlify`)
- ✅ Check browser console for any error messages

## Local Development

For local development, you can use:

```bash
npm run dev
```

This uses the standard Vite dev server. For testing the Netlify build locally:

```bash
npm run build:netlify
npm run preview:netlify
```

## Next Steps

Once connected:
- Try loading Hi-C maps: "Load a Hi-C map from [URL]"
- Try zooming: "Zoom in at coordinates X, Y"
- Try changing colors: "Set foreground color to red"
- Try loading sessions: "Load session from [URL]"
